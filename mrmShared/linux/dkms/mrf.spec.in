%define kmod_name @@DRV_NAME@@

Summary: DKMS kernel module - mrfioc2 driver

Name:    @@RPM_NAME@@
Version: @@RPM_VERSION@@
Release: @@DRV_RELEASE@@

Vendor: EPICS Community
License: EPICS Open License
Group: System Environment/Kernel
URL: https://github.com/epics-modules/mrfioc2
BuildRequires: autoconf libtool gcc gcc-c++
BuildArch: @@ARCH@@
Requires: dkms
Requires: udev
Packager: Michael Abbott <michael.abbott@diamond.ac.uk>
BuildRoot: %{_tmppath}/%{kmod_name}-%{version}-root

# The two target directories
%define dkmsdir /usr/src/%{kmod_name}-%{version}
%define udevdir /etc/udev/rules.d

%description
Installs the kernel driver for interfacing to the MRF Event Receiver over
PCI express.  The driver is installed using dkms.

%install
rm -rf %{buildroot}
mkdir -p %{buildroot}%{dkmsdir} %{buildroot}%{udevdir}
install -m 0644 %{_sourcedir}/uio_mrf.c     %{buildroot}%{dkmsdir}
install -m 0644 %{_sourcedir}/jtag_mrf.c    %{buildroot}%{dkmsdir}
install -m 0644 %{_sourcedir}/mrf.h         %{buildroot}%{dkmsdir}
install -m 0644 %{_curdir}/Makefile.dkms    %{buildroot}%{dkmsdir}/Makefile
install -m 0644 %{_sourcedir}/Kbuild        %{buildroot}%{dkmsdir}
install -m 0644 %{_curdir}/dkms.conf        %{buildroot}%{dkmsdir}
install -m 0644 %{_curdir}/50-mrf.rules     %{buildroot}%{udevdir}

%files
%{dkmsdir}/uio_mrf.c
%{dkmsdir}/jtag_mrf.c
%{dkmsdir}/mrf.h
%{dkmsdir}/Makefile
%{dkmsdir}/Kbuild
%{dkmsdir}/dkms.conf
%{udevdir}/50-mrf.rules

%post
dkms add     -m %{kmod_name} -v %{version} --rpm_safe_upgrade
dkms build   -m %{kmod_name} -v %{version}
dkms install -m %{kmod_name} -v %{version}
modprobe %{kmod_name}

%preun
modprobe -r %{kmod_name}
dkms remove --all -m %{kmod_name} -v %{version} --rpm_safe_upgrade

%postun
rmdir /usr/src/%{kmod_name}-%{version}

%changelog
* Wed Jan 24 2024 Jerzy Jamroz <jerzy.jamroz@gmail.com> - 2-1
- Build adjustments.
- Group rw access for the pci resource0.
- AER handling functions.
